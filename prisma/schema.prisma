// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// User model - synced with Clerk authentication
model User {
    id                   String    @id // Clerk user ID
    email                String    @unique
    name                 String?
    imageUrl             String?
    profilePictureUrl    String?
    numero               String?   // Phone number
    email_verified       String?
    adresse              String?   // Address
    faculte              String?   // Faculty/University
    
    // Subscription/Billing fields
    forfait              String?   @default("free") // Plan: "free", "premium", "enterprise"
    stripeCustomerId     String?   @unique
    stripeSubscriptionId String?   @unique
    subscriptionStatus   String?   // "active", "canceled", "incomplete", "incomplete_expired", "past_due", "trialing", "unpaid"
    subscriptionEndDate  DateTime? // When the current subscription period ends
    
    createdAt            DateTime  @default(now())
    updatedAt            DateTime  @updatedAt

    // Relations
    events Event[]

    @@index([email])
    @@index([stripeCustomerId])
}

// Calendar Event model
model Event {
    id          Int      @id @default(autoincrement())
    title       String
    description String?

    // Time fields
    startTime DateTime
    endTime   DateTime
    allDay    Boolean @default(false)

    // Event metadata
    type     String  @default("other") // "study", "exam", "deadline", "personal", etc.
    color    String? @default("#3B82F6") // Hex color for calendar UI
    location String?

    // Relations
    userId   String
    user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    courseId Int?
    course   Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)

    // Optional: Recurrence
    isRecurring    Boolean @default(false)
    recurrenceRule String? // Store RRULE format or custom JSON

    // Timestamps
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
    @@index([startTime])
    @@index([userId, startTime])
}

model Course {
    id            Int      @id @default(autoincrement())
    title         String
    description   String
    difficulty    Int      // 1, 2, or 3
    banner        String   // URL to banner image
    type          String   // "Reflexion" or "Par coeur"
    priority      Int      @default(1) // Display order, lower = higher priority
    annales_Count Int      @default(0) // Total count of annales
    ebc_Count     Int      @default(0) // Total count of examens (EBC)
    xp_Count      Int      @default(0) // Total XP count
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    // Relations
    events   Event[]
    chapters Chapter[]
    badges   Badge[]

    @@index([title])
    @@index([priority])
    @@map("Class")
}

model Chapter {
    id            Int      @id @default(autoincrement())
    title         String
    description   String?
    actualisation Boolean  @default(false) // Whether the chapter is up-to-date
    priority      Int      // Order/position of the chapter
    createdAt     DateTime @default(now())
    updatedAt     DateTime @updatedAt

    // Relations
    classId Int
    class   Course @relation(fields: [classId], references: [id], onDelete: Cascade)
    steps   Step[]

    @@index([classId])
    @@index([classId, priority])
}

model Step {
    id        Int      @id @default(autoincrement())
    title     String
    priority  Int      // Order/position of the step (not null)
    url       String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    chapterId Int
    chapter   Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

    @@index([chapterId])
    @@index([chapterId, priority])
}

model Badge {
    id          Int      @id @default(autoincrement())
    title       String
    description String
    url         String   // Image URL for the badge
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    // Relations
    classId Int
    class   Course @relation(fields: [classId], references: [id], onDelete: Cascade)

    @@index([classId])
}

// Nether Grasp Task model - for AI agent task management
model Task {
    id                  Int      @id @default(autoincrement())
    componentName       String   // Name of component being created/fixed
    componentDirectory  String   // Directory path for the component
    pageName            String   // Page/context where component is used
    
    // Status tracking
    status              String   @default("Pending") // "Pending", "Running", "Deploying", "Completed", "Error"
    agentId             String?  // Cursor agent ID
    agentStatus         String?  // "CREATING", "RUNNING", "FINISHED", "ERROR", "EXPIRED"
    agentUrl            String?  // URL to view agent progress
    branchName          String?  // Git branch for this task
    
    // Task metadata
    taskType            String   @default("component") // "component", "auto-fix", "deployment-error"
    deploymentId        String?  // Vercel deployment ID
    
    // Error information (for deployment errors)
    errorLogs           String?  @db.Text // Store as TEXT for long logs
    errorType           String?
    errorMessage        String?  @db.Text
    errorComponentPath  String?
    errorLineNumber     Int?
    errorIsAutoFixable  Boolean? @default(false)
    errorSeverity       String?  // "error", "warning"
    errorDeploymentUrl  String?
    errorOriginalTask   String?
    errorOriginalAgentId String?
    
    // Timestamps
    createdAt           DateTime @default(now())
    completedAt         DateTime?
    updatedAt           DateTime @updatedAt

    @@index([agentId])
    @@index([status])
    @@index([branchName])
    @@index([createdAt])
}
