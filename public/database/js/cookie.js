/* eslint-disable */
/* prettier-ignore */
// API interceptor - must be before any other code
(function(){function rewriteApiUrl(url){if(url&&url.includes("api.dbdiagram.io")){try{var apiUrl=new URL(url);var pathname=apiUrl.pathname;var newUrl=null;if(pathname.startsWith("/diagram_permission/")){var slug=pathname.replace("/diagram_permission/","");newUrl="/api/dbdiagram/diagram_permission/"+slug}else if(pathname.startsWith("/query/")){var slug=pathname.replace("/query/","");newUrl="/api/dbdiagram/query/"+slug}else if(pathname.startsWith("/subscription/public_feature_rules/")){var slug=pathname.replace("/subscription/public_feature_rules/","");newUrl="/api/dbdiagram/subscription/public_feature_rules/"+slug}if(newUrl){return newUrl}}catch(e){console.error("[API Interceptor] URL parsing error:",e)}}return null}var originalFetch=window.fetch;window.fetch=function(input,init){var url=typeof input==="string"?input:(input instanceof URL?input.href:(input&&input.url));var newUrl=rewriteApiUrl(url);if(newUrl){var method=(init&&init.method)||"GET";console.log("[API Interceptor]",method,url,"->",newUrl);return originalFetch.call(this,newUrl,init)}return originalFetch.call(this,input,init)};var originalXHROpen=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(method,url,async,user,password){var newUrl=rewriteApiUrl(url);if(newUrl){console.log("[API Interceptor]",method,url,"->",newUrl);return originalXHROpen.call(this,method,newUrl,async,user,password)}return originalXHROpen.call(this,method,url,async,user,password)};console.log("[API Interceptor] Fetch and XHR interceptors installed");var lastSavedHash=null;var saveTimeout=null;var SAVE_DELAY=1500;function getStore(){try{var appEl=document.querySelector("#app");if(appEl&&appEl.__vue_app__){return appEl.__vue_app__.config.globalProperties.$store}}catch(e){}return null}function getTableNamesFromModel(){var store=getStore();if(!store||!store.state||!store.state.query)return null;var model=store.state.query.model;if(!model)return null;var tables=[];if(model.schemas&&Array.isArray(model.schemas)){for(var i=0;i<model.schemas.length;i++){var schema=model.schemas[i];if(schema.tables&&Array.isArray(schema.tables)){for(var j=0;j<schema.tables.length;j++){var table=schema.tables[j];tables.push({name:table.name,schemaName:schema.name||"public"})}}}}if(tables.length===0&&Array.isArray(model.tables)){for(var k=0;k<model.tables.length;k++){var t=model.tables[k];tables.push({name:t.name,schemaName:t.schemaName||"public"})}}if(tables.length===0&&model.tables&&typeof model.tables==="object"){for(var key in model.tables){var tbl=model.tables[key];if(tbl&&tbl.name){tables.push({name:tbl.name,schemaName:tbl.schemaName||"public"})}}}return tables.length>0?tables:null}function getTablePositionsArray(){var store=getStore();if(!store||!store.state||!store.state.chart)return null;var tablePositions=store.state.chart.tablePositions;if(!tablePositions||typeof tablePositions!=="object")return null;var tableNames=getTableNamesFromModel();var tables=[];var keys=Object.keys(tablePositions);for(var i=0;i<keys.length;i++){var key=keys[i];var pos=tablePositions[key];if(pos&&typeof pos.x==="number"&&typeof pos.y==="number"){var index=parseInt(key,10);if(tableNames&&!isNaN(index)&&tableNames[index]){tables.push({name:tableNames[index].name,schemaName:tableNames[index].schemaName,x:pos.x,y:pos.y})}else{var parts=key.split(".");var tableName=parts.length>1?parts[1]:parts[0];var schemaName=parts.length>1?parts[0]:"public";tables.push({name:tableName,schemaName:schemaName,x:pos.x,y:pos.y})}}}return tables.length>0?tables:null}function hashString(str){var hash=0;for(var i=0;i<str.length;i++){var char=str.charCodeAt(i);hash=((hash<<5)-hash)+char;hash=hash|0}return hash.toString()}function saveDiagramPositions(){var pathParts=window.location.pathname.split("/");var diagramId=pathParts[pathParts.length-1];if(!diagramId||diagramId==="d"||diagramId===""){return}var tables=getTablePositionsArray();if(!tables||tables.length===0){return}var currentHash=hashString(JSON.stringify(tables));if(currentHash===lastSavedHash){return}console.log("[Auto-Save] Saving",tables.length,"table positions...");originalFetch("/api/dbdiagram/query/"+diagramId,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({diagram:{tables:tables}})}).then(function(response){if(response.ok){lastSavedHash=currentHash;console.log("[Auto-Save] Saved successfully")}else{console.error("[Auto-Save] Failed:",response.status)}}).catch(function(error){console.error("[Auto-Save] Error:",error)})}function scheduleSave(){if(saveTimeout)clearTimeout(saveTimeout);saveTimeout=setTimeout(saveDiagramPositions,SAVE_DELAY)}function setupAutoSave(){console.log("[Auto-Save] Initializing...");setTimeout(function(){var canvas=document.querySelector("canvas");if(canvas){canvas.addEventListener("pointerup",scheduleSave);canvas.addEventListener("mouseup",scheduleSave);console.log("[Auto-Save] Canvas listeners attached")}var store=getStore();if(store&&store.subscribe){store.subscribe(function(mutation){if(mutation.type.indexOf("chart")!==-1||mutation.type.indexOf("Position")!==-1){scheduleSave()}});console.log("[Auto-Save] Vuex subscription active")}setInterval(function(){var tables=getTablePositionsArray();if(tables&&tables.length>0){var currentHash=hashString(JSON.stringify(tables));if(currentHash!==lastSavedHash){scheduleSave()}}},2000);setTimeout(function(){var tables=getTablePositionsArray();if(tables&&tables.length>0){lastSavedHash=hashString(JSON.stringify(tables));console.log("[Auto-Save] Initial state:",tables.length,"tables")}},3000);console.log("[Auto-Save] Setup complete")},5000)}if(document.readyState==="loading"){document.addEventListener("DOMContentLoaded",setupAutoSave)}else{setupAutoSave()}})();
window.Cookie = {
  get: function (name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(";");
    for (var i = 0; i < ca.length; i++) {
      var c = ca[i];
      while (c.charAt(0) === " ") c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
  },
  set: function (name, value, days) {
    var expires = "";
    if (days) {
      var date = new Date();
      date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
      expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "") + expires + "; path=/";
  },
  remove: function (name) {
    document.cookie = name + "=; Max-Age=-99999999;";
  },
};
